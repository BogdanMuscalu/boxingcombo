<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <title>Combinații aleatoare de brate</title>
    <link rel="stylesheet" href="app.min.css">
    <style>
        .text-center {
            text-align: center;
        }

        .app-section {
            font-weight: bold;
        }

        .app-topbar .app-button span {
            padding: 3px 5px;
            border-radius: 6px;
            border: 2px solid #000;
            font-size: 1.2em;
            font-weight: bold !important;
        }

        .selected {
            border: 2px solid #fff !important;
        }

        .more {
            display: none;
        }
    </style>
</head>

<body>
<div class="app-page" data-page="home">
    <div class="app-topbar">
        <div class="app-button left players" data-players="1"><span id="onePlayer">Singur</span></div>
        <div class="app-title">
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cum bagi?
        </div>
        <div class="app-button right players" data-players="2"><span id="twoPlayers" class="selected">În doi</span>
        </div>
    </div>
    <div class="app-content">
        <div class="app-section text-center">
            Câte secunde între combinații?
        </div>
        <div class="app-section">
            <div class="app-button start less" data-seconds="2">2 Secunde</div>
            <div class="app-button start less" data-seconds="3">3 Secunde</div>
            <div class="app-button start" data-seconds="4">4 Secunde</div>
            <div class="app-button start" data-seconds="5">5 Secunde</div>
            <div class="app-button start" data-seconds="6">6 Secunde</div>
            <div class="app-button start" data-seconds="7">7 Secunde</div>
            <div class="app-button start" data-seconds="8">8 Secunde</div>
            <div class="app-button start more" data-seconds="9">9 Secunde</div>
            <div class="app-button start more" data-seconds="9">10 Secunde</div>
        </div>
        <div class="app-section">
            <div class="app-button" id="stop">Stop</div>
        </div>
    </div>
</div>

<script src="zepto.js"></script>
<script src="app.min.js"></script>
<script>

    var comboInterval;
    var strikeTimerArray = [];
    var players;

    // initial player setting if not found in local storage
    var oldPlayers = "2";

    var currentAudio = new Audio();
    var running = false;

    // negative duration between playback of audio files inside a combo
    var shortenPlayback = 80;

    // the array of audio durations
    var durationsArray = [0, 365.714, 391.837, 365.714, 417.959, 470.204, 548.571, 574.694, 391.837, 731.429, 679.184, 653.061, 731.429, 600.816];
    // create audios array
    var audiosArray = [0];
    for ( i = 1; i <= 13; i++ ) {
        audiosArray.push( new Audio('audio/' + i.toString() + '.mp3') );
    }

    // get the setting out of local storage
    if (typeof localStorage !== 'undefined') {
        if (localStorage.getItem('comboPlayers')) {
            players = localStorage.getItem('comboPlayers');
        }
    }
    // use the setting from local storage
    setPlayers(players);

    // implements a new setting and saves it
    function setPlayers(playerString) {
        if (playerString !== oldPlayers) {
            if (playerString === "1") {
                $("#onePlayer").addClass('selected');
                $("#twoPlayers").removeClass('selected');
                $(".less").hide();
                $(".more").show();
                $(".less").last().next().css("margin-top", "0");
            } else {
                $("#onePlayer").removeClass('selected');
                $("#twoPlayers").addClass('selected');
                $(".less").show();
                $(".more").hide();
                $(".less").last().next().css("margin-top", "8px");
            }
            oldPlayers = playerString;
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('comboPlayers', playerString);
            }
        }
    }

    // creates an array of strikes
    function createCombo() {

        var outputArray = [];

        if (players === "2") {

            outputArray.push(Math.ceil(Math.random() * 4) * 2 - 1);
            outputArray.push(Math.ceil(Math.random() * 4) * 2);

        } else {

            outputArray.push(Math.ceil(Math.random() * 2) * 2 - 1);
            outputArray.push(Math.ceil(Math.random() * 4) * 2);
            outputArray.push(Math.ceil(Math.random() * 3) * 2 + 1);
            if (Math.floor(Math.random() * 2)) {
                outputArray.push(Math.ceil(Math.random() * 4) * 2);
            }
            outputArray.push(Math.ceil(Math.random() * 5) + 8);
        }

        return outputArray;
    }

    // plays an array of strikes
    function playCombo(comboArray) {

        var delay = 0;

        // loop through the array
        comboArray.forEach(function (value, index) {
            // enqueue all audio files according to their duration
            // put them in an array for an easy clearInterval to stop playing
            strikeTimerArray.push( setTimeout(function() {
                audiosArray[value].play()
            }, delay - (shortenPlayback * index)) );

            delay += durationsArray[value];
        });
    }

    // create and play combo using .onended to play them one after the other
//    function playCombo() {
//
//        if (players === "2") {
//
//            var firstStrike = Math.ceil(Math.random() * 4) * 2 - 1;
//            var secondStrike = Math.ceil(Math.random() * 4) * 2;
//
//            var firstAudio = new Audio('audio/' + firstStrike.toString() + '.mp3');
//            var secondAudio = new Audio('audio/' + secondStrike.toString() + '.mp3');
//
//            currentAudio = firstAudio;
//            firstAudio.play();
//            firstAudio.onended = function () {
//                currentAudio = secondAudio;
//                secondAudio.play();
//            }
//
//        } else {
//
//            var firstStrike = Math.ceil(Math.random() * 2) * 2 - 1;
//            var secondStrike = Math.ceil(Math.random() * 4) * 2;
//            var thirdStrike = Math.ceil(Math.random() * 3) * 2 + 1;
//            var addFourthStrike = Math.floor(Math.random() * 2);
//            var fourthStrike = Math.ceil(Math.random() * 4) * 2;
//            var legStrike = Math.ceil(Math.random() * 5) + 8;
//
//            var firstAudio = new Audio('audio/' + firstStrike.toString() + '.mp3');
//            var secondAudio = new Audio('audio/' + secondStrike.toString() + '.mp3');
//            var thirdAudio = new Audio('audio/' + thirdStrike.toString() + '.mp3');
//            var fourthAudio = new Audio('audio/' + fourthStrike.toString() + '.mp3');
//            var lastAudio = new Audio('audio/' + legStrike.toString() + '.mp3');
//
//            currentAudio = firstAudio;
//            firstAudio.play();
//            firstAudio.onended = function () {
//                currentAudio = secondAudio;
//                secondAudio.play();
//            }
//            secondAudio.onended = function () {
//                currentAudio = thirdAudio;
//                thirdAudio.play();
//            }
//            if (addFourthStrike) {
//                thirdAudio.onended = function () {
//                    currentAudio = fourthAudio;
//                    fourthAudio.play();
//                }
//                fourthAudio.onended = function () {
//                    currentAudio = lastAudio;
//                    lastAudio.play();
//                }
//            } else {
//                thirdAudio.onended = function () {
//                    currentAudio = lastAudio;
//                    lastAudio.play();
//                }
//            }
//        }
//    }

    // stop playing audio, clear all intervals
    function stopPlaying() {

//        currentAudio.pause();
//        currentAudio.currentTime = 0;

        strikeTimerArray.forEach(function (strikeTimer) {
            clearInterval(strikeTimer);
        });

        clearInterval(comboInterval);

        strikeTimerArray = [];

        running = false;
    }

    // app.js page controller
    App.controller('home', function (page) {

        // when clicking a button to change the players setting
        $(page).find('.players').on('click', function () {

            stopPlaying();

            players = $(this)[0].dataset.players;
            setPlayers(players);
        });

        // when clicking a button to start playing
        $(page).find('.start').on('click', function () {

            stopPlaying();

            seconds = $(this)[0].dataset.seconds;
            playCombo(createCombo());

            comboInterval = setInterval(function () {
                playCombo(createCombo());
            }, seconds * 1000);

            running = true;

        });

        // when clicking the stop button
        $(page).find('#stop').on('click', function () {

            stopPlaying();
        });
    });

    try {
        App.restore();
    } catch (err) {
        App.load('home');
    }
</script>
</body>
</html>
